<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>School Stock Market</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:12px; text-align:center; font-size:22px; }
    #loginSection, #stockSection, #adminSection { display:none; padding:20px; }
    .stock { background:#1e1e1e; margin:10px; padding:10px; border-radius:8px; cursor:pointer; }
    button { padding:8px 16px; margin:5px; border:none; border-radius:6px; background:#007bff; color:white; cursor:pointer; }
    button:hover { background:#0056b3; }
    #chartContainer, #financials, #news { margin-top:20px; }
    #portfolio, #leaderboard { margin-top:20px; background:#1c1c1c; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <header>ðŸ“ˆ School Stock Market</header>

  <!-- Login Section -->
  <section id="loginSection">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
  </section>

  <!-- Stock Section -->
  <section id="stockSection">
    <h2>Available Shares</h2>
    <div id="stocks"></div>
    <div id="chartContainer"></div>
    <div id="financials"></div>
    <div id="news"></div>
    <div id="portfolio"></div>
    <div id="leaderboard"></div>
    <button onclick="logout()">Logout</button>
  </section>

  <!-- Admin Section -->
  <section id="adminSection">
    <h2>Admin Panel</h2>
    <p>Registered Users:</p>
    <ul id="userList"></ul>
    <button onclick="logout()">Logout</button>
  </section>

  <!-- TradingView Widget -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

  <script>
    // ===== CONFIG =====
    const SITE_PASSWORD = "vse2k25";
    const ADMIN_EMAIL = "admin62vse.com";
    const ADMIN_PASSWORD = "adminvse2k25";
    const FINNHUB_KEY = "d3bm7n1r01qqg7bv706gd3bm7n1r01qqg7bv7070";

    const SHARES = [
      { symbol: "NSE:RELIANCE", name: "organising department" },
      { symbol: "NSE:TCS", name: "models department" },
      { symbol: "NSE:INFY", name: "tech department" },
      { symbol: "NSE:HDFCBANK", name: "finance department" },
      { symbol: "NSE:ICICIBANK", name: "games department" },
      { symbol: "NSE:ITC", name: "foodstalls department" },
      { symbol: "NSE:SBIN", name: "stalls department" },
      { symbol: "NSE:BHARTIARTL", name: "seminar department" },
      { symbol: "NSE:ASIANPAINT", name: "photography department" }
    ];

    let users = JSON.parse(localStorage.getItem("users") || "[]");
    let currentUser = null;

    // ===== PASSWORD GATE =====
    window.onload = function() {
      let pass = prompt("Enter site password:");
      if (pass === SITE_PASSWORD) {
        document.getElementById("loginSection").style.display = "block";
      } else {
        alert("Wrong password! Refresh and try again.");
      }
    };

    // ===== LOGIN =====
    function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
        currentUser = { email, admin:true };
        showAdmin();
        return;
      }

      let user = users.find(u => u.email === email && u.password === password);
      if (!user) {
        user = { email, password, balance: 100000, portfolio: [] };
        users.push(user);
        saveUsers();
      }
      currentUser = user;
      showStocks();
    }

    // ===== SHOW STOCKS =====
    async function showStocks() {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
      document.getElementById("stockSection").style.display = "block";

      const stockDiv = document.getElementById("stocks");
      stockDiv.innerHTML = "";

      for (let s of SHARES) {
        const price = await fetchStockPrice(s.symbol);
        const div = document.createElement("div");
        div.className = "stock";
        div.innerHTML = `<b>${s.name}</b> (${s.symbol}) - â‚¹${price}
          <button onclick="buyStock('${s.symbol}', ${price})">Buy</button>
          <button onclick="sellStock('${s.symbol}', ${price})">Sell</button>`;
        div.onclick = () => { showChart(s.symbol); showFinancials(s.symbol); showNews(s.symbol); };
        stockDiv.appendChild(div);
      }

      updatePortfolio();
      updateLeaderboard();
      setTimeout(showStocks, 30000); // Auto-refresh every 30s
    }

    async function fetchStockPrice(symbol) {
      const finnhubSymbol = symbol.replace("NSE:", "") + ".NS";
      try {
        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${finnhubSymbol}&token=${FINNHUB_KEY}`);
        const data = await res.json();
        return data.c || "N/A";
      } catch {
        return "N/A";
      }
    }

    // ===== CHART =====
    function showChart(symbol) {
      document.getElementById("chartContainer").innerHTML = "";
      new TradingView.widget({
        "width": "100%",
        "height": 400,
        "symbol": symbol,
        "interval": "D",
        "timezone": "Asia/Kolkata",
        "theme": "dark",
        "style": "1",
        "locale": "en",
        "toolbar_bg": "#111",
        "container_id": "chartContainer"
      });
    }

    // ===== FINANCIALS =====
    async function showFinancials(symbol) {
      const finnhubSymbol = symbol.replace("NSE:", "") + ".NS";
      try {
        const res = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${finnhubSymbol}&metric=all&token=${FINNHUB_KEY}`);
        const data = await res.json();
        const f = data.metric;
        document.getElementById("financials").innerHTML = `
          <h3>Financial Info</h3>
          <p>P/E Ratio: ${f.peNormalizedAnnual || "N/A"}</p>
          <p>Market Cap: ${f.marketCapitalization || "N/A"} B</p>
          <p>52w High: â‚¹${f["52WeekHigh"] || "N/A"}</p>
          <p>52w Low: â‚¹${f["52WeekLow"] || "N/A"}</p>`;
      } catch {
        document.getElementById("financials").innerHTML = "<p>Financial data not available.</p>";
      }
    }

    // ===== NEWS =====
    async function showNews(symbol) {
      const finnhubSymbol = symbol.replace("NSE:", "") + ".NS";
      try {
        const res = await fetch(`https://finnhub.io/api/v1/company-news?symbol=${finnhubSymbol}&from=2024-09-01&to=2024-09-29&token=${FINNHUB_KEY}`);
        const data = await res.json();
        let html = "<h3>Latest News</h3>";
        data.slice(0,3).forEach(n => {
          html += `<p><a href="${n.url}" target="_blank">${n.headline}</a></p>`;
        });
        document.getElementById("news").innerHTML = html;
      } catch {
        document.getElementById("news").innerHTML = "<p>No news available.</p>";
      }
    }

    // ===== BUY / SELL =====
    function buyStock(symbol, price) {
      if (price === "N/A") return alert("Price unavailable");
      if (currentUser.balance < price) return alert("Not enough balance!");
      currentUser.balance -= price;
      let stock = currentUser.portfolio.find(p => p.symbol === symbol);
      if (stock) stock.qty++;
      else currentUser.portfolio.push({ symbol, qty:1 });
      saveUsers(); updatePortfolio(); updateLeaderboard();
    }

    function sellStock(symbol, price) {
      let stock = currentUser.portfolio.find(p => p.symbol === symbol);
      if (!stock || stock.qty <= 0) return alert("You donâ€™t own this stock");
      currentUser.balance += price;
      stock.qty--;
      if (stock.qty === 0) currentUser.portfolio = currentUser.portfolio.filter(p => p.symbol !== symbol);
      saveUsers(); updatePortfolio(); updateLeaderboard();
    }

    // ===== PORTFOLIO =====
    function updatePortfolio() {
      let div = document.getElementById("portfolio");
      div.innerHTML = `<h3>Your Portfolio</h3>
        <p>Balance: â‚¹${currentUser.balance.toFixed(2)}</p>`;
      currentUser.portfolio.forEach(p => {
        div.innerHTML += `<p>${p.symbol} - Qty: ${p.qty}</p>`;
      });
    }

    // ===== LEADERBOARD =====
    function updateLeaderboard() {
      let div = document.getElementById("leaderboard");
      let ranking = users.map(u => {
        let value = u.balance;
        u.portfolio.forEach(p => { value += 1000 * p.qty; }); // approx
        return { email:u.email, value };
      }).sort((a,b) => b.value - a.value);
      div.innerHTML = "<h3>Leaderboard</h3>";
      ranking.slice(0,5).forEach((r,i) => {
        div.innerHTML += `<p>${i+1}. ${r.email} - â‚¹${r.value.toFixed(2)}</p>`;
      });
    }

    // ===== ADMIN =====
    function showAdmin() {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("stockSection").style.display = "none";
      document.getElementById("adminSection").style.display = "block";
      const list = document.getElementById("userList");
      list.innerHTML = "";
      users.forEach(u => {
        const li = document.createElement("li");
        li.textContent = `${u.email} | Balance: â‚¹${u.balance}`;
        list.appendChild(li);
      });
    }

    // ===== LOGOUT =====
    function logout() {
      currentUser = null;
      document.getElementById("loginSection").style.display = "block";
      document.getElementById("stockSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
    }

    // ===== SAVE USERS =====
    function saveUsers() {
      localStorage.setItem("users", JSON.stringify(users));
    }
  </script>
</body>
</html>
